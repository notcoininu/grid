# 网格系统运行指南

## 🚀 快速开始

网格交易系统支持**三种模式**，通过配置文件选择：
- ✅ **普通网格**：固定金额，适合震荡行情
- ⚠️ **马丁网格**：递增金额，风险较高
- 🔄 **价格移动网格**：自动跟随价格，适合趋势行情

---

## 📋 运行前准备

### 1. 配置API密钥

**方式一：环境变量（推荐）**
```bash
export BACKPACK_API_KEY="your_api_key"
export BACKPACK_API_SECRET="your_api_secret"
```

**方式二：配置文件**
编辑 `config/exchanges/backpack_config.yaml`：
```yaml
api_key: "your_api_key"
api_secret: "your_api_secret"
```

### 2. 检查配置文件

确保配置文件存在且参数正确：
```bash
ls -l config/grid/
```

---

## 🎯 运行普通网格

### 普通做多网格

**配置文件**：`config/grid/backpack_long_grid.yaml`

```yaml
grid_system:
  exchange: "backpack"
  symbol: "BTC_USDC_PERP"
  grid_type: "long"           # 普通做多
  
  # 价格区间
  upper_price: 123500.00
  lower_price: 103600.00
  grid_interval: 100.00
  
  order_amount: 0.0001        # 固定金额
  fee_rate: 0.0001            # 手续费率
```

**运行命令**：
```bash
python run_grid_trading.py --config config/grid/backpack_long_grid.yaml
```

**或者使用默认配置**：
```bash
python run_grid_trading.py
```

**特点**：
- ✅ 每个订单金额固定（0.0001 BTC）
- ✅ 风险可控
- ✅ 适合震荡行情

---

### 普通做空网格

**配置文件**：`config/grid/backpack_short_grid.yaml`

```yaml
grid_system:
  exchange: "backpack"
  symbol: "BTC_USDC_PERP"
  grid_type: "short"          # 普通做空
  
  upper_price: 123500.00
  lower_price: 103600.00
  grid_interval: 100.00
  order_amount: 0.0001
  fee_rate: 0.0001
```

**运行命令**：
```bash
python run_grid_trading.py --config config/grid/backpack_short_grid.yaml
```

**特点**：
- ✅ 每个订单金额固定
- ✅ 做空策略
- ✅ 适合下跌行情

---

## 🎲 运行马丁网格

### 马丁做多网格

**配置文件**：`config/grid/backpack_martingale_long_grid.yaml`

```yaml
grid_system:
  exchange: "backpack"
  symbol: "BTC_USDC_PERP"
  grid_type: "martingale_long"
  
  upper_price: 123500.00
  lower_price: 103600.00
  grid_interval: 100.00
  order_amount: 0.001         # 基础金额
  martingale_increment: 0.001 # 递增金额
  max_position: 20.0          # 必须设置
  fee_rate: 0.0001
```

**运行命令**：
```bash
python run_grid_trading.py --config config/grid/backpack_martingale_long_grid.yaml
```

**特点**：
- ⚠️ 订单金额递增（0.001, 0.002, 0.003...）
- ⚠️ 价格越低，买入金额越大
- ⚠️ 风险较高，需要更多资金
- ✅ 适合回归行情

**金额分布示例**：
```
Grid 1   (123400): 0.001 BTC  ← 最高价格，最小金额
Grid 2   (123300): 0.002 BTC
Grid 3   (123200): 0.003 BTC
Grid 10  (122500): 0.010 BTC
Grid 50  (119500): 0.050 BTC
Grid 100 (113500): 0.100 BTC
Grid 199 (103700): 0.199 BTC  ← 最低价格，最大金额
```

---

### 马丁做空网格

**配置文件**：`config/grid/backpack_martingale_short_grid.yaml`

```yaml
grid_system:
  exchange: "backpack"
  symbol: "BTC_USDC_PERP"
  grid_type: "martingale_short"
  
  upper_price: 123500.00
  lower_price: 103600.00
  grid_interval: 100.00
  order_amount: 0.001
  martingale_increment: 0.001
  max_position: 20.0
  fee_rate: 0.0001
```

**运行命令**：
```bash
python run_grid_trading.py --config config/grid/backpack_martingale_short_grid.yaml
```

**特点**：
- ⚠️ 订单金额递增
- ⚠️ 价格越高，卖出金额越大
- ⚠️ 做空风险无上限
- ✅ 适合回归行情

**金额分布示例**：
```
Grid 1   (103700): 0.001 BTC  ← 最低价格，最小金额
Grid 2   (103800): 0.002 BTC
Grid 3   (103900): 0.003 BTC
Grid 10  (104600): 0.010 BTC
Grid 50  (108600): 0.050 BTC
Grid 100 (113600): 0.100 BTC
Grid 199 (123400): 0.199 BTC  ← 最高价格，最大金额
```

---

## 🔄 运行价格移动网格

### 价格移动做多网格

**配置文件**：`config/grid/backpack_follow_long_grid.yaml`

```yaml
grid_system:
  exchange: "backpack"
  symbol: "BTC_USDC_PERP"
  grid_type: "follow_long"      # 价格移动做多
  
  # 不需要设置 upper_price 和 lower_price
  follow_grid_count: 200        # 网格数量
  grid_interval: 50.00          # 网格间隔
  follow_timeout: 300           # 脱离超时（秒）
  follow_distance: 2            # 脱离距离（格数）
  
  order_amount: 0.0001
  fee_rate: 0.0001
```

**运行命令**：
```bash
python run_grid_trading.py --config config/grid/backpack_follow_long_grid.yaml
```

**特点**：
- 🔄 价格区间自动跟随当前价格
- 🔄 当前价格为上限，向下计算下限
- 🔄 价格向上脱离时自动重置网格
- ✅ 适合上涨趋势行情

**工作原理**：
```
假设当前价格 = $100,000
网格数量 = 200
网格间隔 = $50

自动计算：
  上限 = $100,000（当前价格）
  下限 = $100,000 - (200 × $50) = $90,000
  挂单：$90,050 ~ $99,950（200个买单）

价格脱离触发：
  向上脱离：价格 > $100,100 且持续 5 分钟
  → 取消所有订单，重新初始化网格
  
  向下脱离：不做任何操作（等待价格恢复）
```

---

### 价格移动做空网格

**配置文件**：`config/grid/backpack_follow_short_grid.yaml`

```yaml
grid_system:
  exchange: "backpack"
  symbol: "BTC_USDC_PERP"
  grid_type: "follow_short"     # 价格移动做空
  
  follow_grid_count: 200
  grid_interval: 100.00
  follow_timeout: 300
  follow_distance: 1
  
  order_amount: 0.0001
  fee_rate: 0.0001
```

**运行命令**：
```bash
python run_grid_trading.py --config config/grid/backpack_follow_short_grid.yaml
```

**特点**：
- 🔄 当前价格为下限，向上计算上限
- 🔄 价格向下脱离时自动重置网格
- ✅ 适合下跌趋势行情

---

## 📊 运行参数对比

### 三种模式对比

| 特性 | 普通网格 | 马丁网格 | 价格移动网格 |
|------|----------|----------|------------|
| **订单金额** | 固定 | 递增 | 固定 |
| **价格区间** | 固定 | 固定 | 动态跟随 |
| **配置参数** | `long/short` | `martingale_long/short` | `follow_long/short` |
| **特殊参数** | 无 | `martingale_increment` | `follow_grid_count` |
| **风险等级** | 低-中 | 高 | 中 |
| **资金要求** | 较少 | 较多 | 中等 |
| **适用场景** | 震荡行情 | 回归行情 | 趋势行情 |
| **网格重置** | 无 | 无 | 自动重置 |

### 持仓对比（100个网格成交）

**普通网格**：
```
每个订单：0.001 BTC
总持仓：100 * 0.001 = 0.100 BTC
```

**马丁网格**：
```
订单范围：0.001 ~ 0.100 BTC
总持仓：(0.001 + 0.100) * 100 / 2 = 5.050 BTC  ← 50.5倍
```

---

## 🎮 运行控制

### 启动系统

```bash
# 普通做多网格
python run_grid_trading.py --config config/grid/backpack_long_grid.yaml

# 马丁做多网格
python run_grid_trading.py --config config/grid/backpack_martingale_long_grid.yaml

# 价格移动做多网格
python run_grid_trading.py --config config/grid/backpack_follow_long_grid.yaml
```

### 停止系统

**方式一：快捷键**
```
按 Ctrl+C（优雅退出）
```

**方式二：终端命令**
```
[P] 暂停
[S] 停止
[Q] 退出
```

### 查看日志

**实时日志**：
```bash
# 主日志
tail -f logs/core.services.grid.coordinator.grid_coordinator.log

# 引擎日志
tail -f logs/core.services.grid.implementations.grid_engine_impl.log

# 策略日志
tail -f logs/core.services.grid.implementations.grid_strategy_impl.log
```

**查看所有日志**：
```bash
ls -lh logs/
```

---

## 📈 终端界面说明

### 界面布局

```
┌─────────────────────────────────────────────────┐
│  网格交易系统实时监控 - BACKPACK/BTC_USDC_PERP   │
├─────────────────────────────────────────────────┤
│  运行状态                                        │
│  ├─ 网格策略: 做多网格 (199格)  状态: 🟢 运行中  │
│  ├─ 价格区间: $103,600.00 - $123,500.00         │
│  ├─ 当前价格: $122,029.30  当前位置: Grid 10/199│
│  └─ 运行时长: 0:08:17                           │
├─────────────────────────────────────────────────┤
│  订单统计                                        │
│  ├─ 监控方式: 📡 WebSocket                      │
│  ├─ 未成交买单: 147个 (Grid 11-199) ⏳          │
│  ├─ 未成交卖单: 10个 (Grid 1-10) ⏳             │
│  └─ 总挂单数量: 157个                           │
├─────────────────────────────────────────────────┤
│  持仓信息                                        │
│  ├─ 当前持仓: +0.0010 BTC (做多)                │
│  ├─ 可用资金: $0.00 USDC                       │
│  └─ 未实现盈亏: $-0.74 (-0.60%)                │
├─────────────────────────────────────────────────┤
│  盈亏统计                                        │
│  ├─ 已卖现: +$0.00    网格收益: +$0.00         │
│  ├─ 未实现: $-0.74    手续费: -$0.06           │
│  └─ 总盈亏: $-0.74 (-0.04%)  净收益: $-0.80    │
├─────────────────────────────────────────────────┤
│  触发统计                                        │
│  ├─ 买单成交: 10次    卖单成交: 0次            │
│  ├─ 完成循环: 0次 (一买一卖)                    │
│  └─ 平均循环收益: $0.00  网格利用率: 0.0%      │
├─────────────────────────────────────────────────┤
│  最近成交订单 (最新5条)                         │
│  时间      类型  价格        数量      网格层级  │
│  05:08:50  BUY   $123,400.00 0.0001 BTC Grid 1 │
│  05:08:46  BUY   $122,200.00 0.0001 BTC Grid 9 │
│  ...                                            │
└─────────────────────────────────────────────────┘
  [P]暂停  [R]恢复  [S]停止  [Q]退出
```

### 关键指标说明

**运行状态**：
- 🟢 运行中：系统正常运行
- 🟡 暂停中：用户暂停
- 🔴 已停止：系统停止

**监控方式**：
- 📡 WebSocket：实时监控（推荐）
- 📊 REST轮询：备用监控

**订单统计**：
- 未成交买单：当前挂单中的买单数量
- 未成交卖单：当前挂单中的卖单数量
- 总挂单数量：买单 + 卖单

**持仓信息**：
- 当前持仓：实际持仓数量（正数=做多，负数=做空）
- 可用资金：账户可用余额
- 未实现盈亏：当前持仓的浮动盈亏

**盈亏统计**：
- 已实现：已平仓的盈亏
- 未实现：当前持仓的浮动盈亏
- 总盈亏：已实现 + 未实现
- 净收益：总盈亏 - 手续费

---

## ⚙️ 配置参数详解

### 通用参数

```yaml
grid_system:
  exchange: "backpack"
  symbol: "BTC_USDC_PERP"
  
  # 网格类型（6种）
  grid_type: "long"                # long/short/martingale_long/martingale_short/follow_long/follow_short
  
  # 价格区间（普通/马丁网格）
  upper_price: 123500.00
  lower_price: 103600.00
  grid_interval: 100.00
  
  # 订单设置
  order_amount: 0.0001
  fee_rate: 0.0001                 # 手续费率
  
  # 可选设置
  max_position: 2.0
  order_health_check_interval: 600
```

### 马丁网格专用参数

```yaml
  martingale_increment: 0.001      # 每格递增金额
```

### 价格移动网格专用参数

```yaml
  follow_grid_count: 200           # 网格数量（用户指定）
  follow_timeout: 300              # 脱离超时（秒）
  follow_distance: 2               # 脱离距离（格数）
  # 不需要设置 upper_price 和 lower_price
```

### 参数计算

**网格数量**：
```
grid_count = (upper_price - lower_price) / grid_interval
例如：(123500 - 103600) / 100 = 199个网格
```

**订单金额（普通网格）**：
```
每个订单：order_amount
例如：0.0001 BTC（固定）
```

**订单金额（马丁网格）**：
```
Grid N: order_amount + (N-1) * martingale_increment
例如：
  Grid 1:  0.001 + (1-1) * 0.001 = 0.001 BTC
  Grid 10: 0.001 + (10-1) * 0.001 = 0.010 BTC
  Grid 100: 0.001 + (100-1) * 0.001 = 0.100 BTC
```

---

## 🔍 监控和诊断

### 健康检查

系统每10分钟自动检查订单健康状态：

**正常情况**：
```
✅ 订单健康检查正常：预期=199个，实际=199个
```

**异常情况**：
```
⚠️ 订单健康检查异常：预期=199个，实际=195个，差异=-4个
📊 订单详情：买单=185个，卖单=10个
📊 本地追踪：挂单=195个
```

### 日志分析

**查看初始化日志**：
```bash
grep "初始化" logs/core.services.grid.coordinator.grid_coordinator.log
```

**查看成交日志**：
```bash
grep "订单成交" logs/core.services.grid.coordinator.grid_coordinator.log
```

**查看健康检查日志**：
```bash
grep "健康检查" logs/core.services.grid.implementations.grid_engine_impl.log
```

---

## ⚠️ 注意事项

### 普通网格

**适用场景**：
- ✅ 震荡行情
- ✅ 有明确区间
- ✅ 资金有限

**风险提示**：
- ⚠️ 单边行情可能持续亏损
- ⚠️ 需要设置合理的价格区间

### 马丁网格

**适用场景**：
- ✅ 回归行情
- ✅ 有明确支撑/阻力
- ✅ 资金充足

**风险提示**：
- ❌ 持仓增长极快（二次方增长）
- ❌ 单边行情风险极高
- ❌ 必须设置 `max_position`
- ❌ 需要大量资金

**强烈建议**：
1. ✅ 小额测试：先用最小金额测试
2. ✅ 设置限制：必须设置 `max_position`
3. ✅ 密切监控：随时关注持仓变化
4. ✅ 止损准备：准备好止损方案

---

## 🆘 常见问题

### Q1: 如何切换网格模式？

**A**: 修改配置文件中的 `grid_type` 和相关参数：

```yaml
# 普通网格
grid_type: "long"
order_amount: 0.0001

# 马丁网格
grid_type: "martingale_long"
order_amount: 0.001
martingale_increment: 0.001
```

### Q2: 如何调整网格数量？

**A**: 修改 `grid_interval`（网格间隔）：

```yaml
# 更多网格（间隔更小）
grid_interval: 50.00   # 399个网格

# 更少网格（间隔更大）
grid_interval: 200.00  # 99个网格
```

### Q3: 马丁网格风险太大怎么办？

**A**: 调整参数降低风险：

```yaml
# 保守设置
order_amount: 0.0005              # 更小的基础金额
martingale_increment: 0.0002      # 更小的递增幅度
max_position: 5.0                 # 更严格的持仓限制
```

### Q4: 如何查看当前是哪种模式？

**A**: 查看日志或终端界面：

```bash
# 日志
grep "初始化.*网格" logs/core.services.grid.coordinator.grid_coordinator.log

# 输出示例
初始化martingale_long网格: 区间[103600.00, 123500.00], 间隔100.00, 199个网格
```

---

## 📝 总结

### 运行命令速查

```bash
# 普通网格
python run_grid_trading.py --config config/grid/backpack_long_grid.yaml
python run_grid_trading.py --config config/grid/backpack_short_grid.yaml

# 马丁网格
python run_grid_trading.py --config config/grid/backpack_martingale_long_grid.yaml
python run_grid_trading.py --config config/grid/backpack_martingale_short_grid.yaml

# 价格移动网格
python run_grid_trading.py --config config/grid/backpack_follow_long_grid.yaml
python run_grid_trading.py --config config/grid/backpack_follow_short_grid.yaml
```

### 模式选择建议

**新手推荐**：
- ✅ 普通做多网格（`backpack_long_grid.yaml`）
- ✅ 小金额测试
- ✅ 熟悉系统后再尝试其他模式

**震荡行情**：
- ✅ 普通网格（固定金额，风险可控）

**趋势行情**：
- ✅ 价格移动网格（自动跟随价格，适合单边行情）

**回归行情**：
- ⚠️ 马丁网格（风险极高，需充足资金）

**风险提示**：
- ⚠️ 马丁网格风险极高，仅适合经验丰富的用户
- ⚠️ 价格移动网格会自动重置，需注意资金管理
- ⚠️ 建议先用小金额测试

---

**最后更新**：2025-10-05  
**文档版本**：v2.0（新增价格移动网格）
